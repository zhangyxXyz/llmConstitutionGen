---
name: Soul 项目关键系统使用指南
description: 介绍核心系统的路径、常用 API 与注意事项，覆盖相机、AI 行为树、战斗、音频等模块的正确用法
allowed-tools: *
permission: allow
---

# Soul 项目关键系统使用指南

本文档提供 Soul 项目核心系统的使用方法和最佳实践。

## 相机系统（核心）

### 基本信息
- **位置**: `Assets/Scripts/Soul/Camera/`
- **核心类**: `SoulCameraManager`
- **依赖**: Cinemachine

### 常用 API

```csharp
// 切换相机
SoulCameraManager.Instance.SwitchCamera(CameraType.Battle);

// 相机震动
SoulCameraManager.Instance.Shake(intensity, duration);

// 相机栈管理
SoulCameraManager.Instance.PushCamera(camera, priority);
SoulCameraManager.Instance.PopCamera();

// 遮挡半透明（SemiHidden）
// 当相机被遮挡时，自动调整对象透明度
```

### ⚠️ 重要约定

- ❌ **禁止直接操作 `Camera.main`**
- ✅ 必须通过 `SoulCameraManager` 操作相机
- ⚠️ 修改相机系统时要考虑相机优先级和栈管理
- ⚠️ 确保与 Cinemachine 的集成正确
- ⚠️ 涉及渲染的修改要考虑 SOC 剔除系统的影响

---

## AI 行为树系统

### 基本信息
- **位置**: `Assets/Scripts/Editor/AI/BehaviorTree/`
- **特性**: 可视化编辑器支持

### 常用 API

```csharp
// Blackboard 共享数据
blackboard.SetValue("TargetEnemy", enemy);
var target = blackboard.GetValue<GameObject>("TargetEnemy");

// 任务节点序列化
// 编辑器中设计的行为树会自动序列化为运行时数据
```

### 工作流程

1. 打开 AI 行为树编辑器
2. 创建或修改行为节点
3. 使用 Blackboard 共享数据
4. 保存并测试序列化

---

## 战斗系统

### 基本信息
- **位置**: `Assets/Scripts/Soul/Battle/`
- **核心模式**: BattleRoyale（大逃杀）

### 战斗回放系统

```csharp
// 开始录制
BattleReplay.StartRecord();

// 停止录制
BattleReplay.StopRecord();

// 播放回放
BattleReplay.PlayReplay(replayData);
```

⚠️ **重要**: 修改战斗逻辑时必须确保回放系统兼容性！

### 资源管理

```csharp
// 预加载战斗资源
BattleResourcePreparation.PreloadResources(resourceList);

// 大逃杀模式
BattleRoyaleManager.Instance.StartMatch();
```

---

## 音频系统（重要）

### 基本信息
- **音频中间件**: Wwise
- ❌ **禁止使用 Unity 的 `AudioSource`**

### 常用 API

```csharp
// 播放音效
AkSoundEngine.PostEvent("Play_SFX_Gunshot", gameObject);

// 播放音乐
AkSoundEngine.PostEvent("Play_BGM_Battle", gameObject);

// 停止音效
AkSoundEngine.PostEvent("Stop_SFX_Gunshot", gameObject);

// 3D 定位音效
AkSoundEngine.PostEvent("Play_SFX_Footstep", gameObject);
```

### 音频 Bank 管理

```csharp
// 加载音频 Bank
AkSoundEngine.LoadBank("BankName", out bankId);

// ⚠️ 使用完毕必须卸载
AkSoundEngine.UnloadBank("BankName");
```

---

## 输入系统

### 基本信息
- **位置**: `Assets/Scripts/Soul/InputSystem/`
- **使用**: Unity Input System

### 输入事件订阅

```csharp
// 订阅输入动作
InputSystem.actions["Fire"].performed += OnFire;
InputSystem.actions["Jump"].performed += OnJump;

// ⚠️ 必须在 OnDisable 中取消订阅
void OnDisable() 
{
    InputSystem.actions["Fire"].performed -= OnFire;
    InputSystem.actions["Jump"].performed -= OnJump;
}
```

---

## 网络系统

### 基本信息
- **位置**: `Assets/Scripts/Soul/Network/`
- **框架**: Mirror/KHEngine

### 消息发送和接收

```csharp
// 发送消息
NetworkManager.Send(new C2S_BattleStart());

// 接收消息
NetworkManager.Register<S2C_BattleResult>(OnBattleResult);
```

### Mirror 网络同步

```csharp
// SyncVar 同步变量
[SyncVar] private int m_health;

// 客户端 -> 服务器
[Command]
void CmdAttack(int targetId) 
{
    // ⚠️ 必须校验参数
    if (targetId <= 0) return;
    // 执行逻辑
}

// 服务器 -> 客户端
[ClientRpc]
void RpcTakeDamage(int damage) 
{
    // 更新客户端表现
}

// 仅服务器执行
[Server]
void ServerOnlyMethod() 
{
    // 服务器逻辑
}

// 仅客户端执行
[Client]
void ClientOnlyMethod() 
{
    // 客户端逻辑
}
```

---

## 配置系统

### 基本信息
- **配置格式**: Excel + FlatBuffers
- **配置类位置**: `Packages/soul.proto.config/DataConfig/DataProto/`
- **配置源文件**: `BuildDataConfig/DataConfig/`

### 获取配置值

```csharp
// 运行时获取配置
BaseDataConfigManager.Instance.TryGetCommonKeyValueConfigDictItem(key, out var value);
```

### 配置查找流程

1. **定位配置类**：在 `Packages/soul.proto.config/DataConfig/DataProto/` 找到配置类文件
2. **查看元数据**：读取文件头部的 `<Meta> <Xlsx>` 和 `<Meta> <Sheet>` 信息
3. **找到源文件**：在 `BuildDataConfig/DataConfig/` 找到对应的 Excel 文件
4. **查看具体配置**：打开 Excel 文件查看配置数据

### 配置文件元数据示例

```csharp
// <auto-generated>
//  automatically generated by the FlatBuffers compiler, do not modify
//   Metadata
//      <Meta> <Proto>: CommonKeyValueConfig.proto
//      <Meta> <Xlsx>: CommonKeyValue          // Excel 文件名
//      <Meta> <Sheet>: CommonKeyValue         // Excel 页签名
//      <Meta> <SkipCodeGen>: False
//      <Meta> <EditorOnly>: False
//      <Meta> <LoadMode>: Dict
//      <Meta> <LayerType>: KH
//      <Meta> <ShareStruct>: False
//      <Meta> <GenClassApi>: True
//      <Meta> <PCOnly>: False
// </auto-generated>
```

---

## 资源管理系统

### AB 包管理

```csharp
// 加载资源
await ResourceManager.LoadAssetAsync<GameObject>(path);

// ⚠️ 使用完毕必须卸载
ResourceManager.Unload(path);
```

### 大资源管理

```csharp
// 加载纹理
Texture2D tex = await ResourceManager.LoadAsync<Texture2D>(path);

// ⚠️ 使用完毕必须释放
Resources.UnloadAsset(tex);
```

---

## 对象池系统

### 基本用法

```csharp
// 从对象池获取对象
var obj = InstancePool.Get<GameObject>(prefab);

// 使用对象
// ...

// 归还到对象池
InstancePool.Release(obj);
```

### 性能优化建议

- ✅ 频繁创建销毁的对象应使用对象池
- ✅ 避免在 Update/FixedUpdate 中频繁 `new` 对象
- ✅ 使用对象池可以显著减少 GC 压力

---

## 事件系统

### 事件订阅和取消订阅

```csharp
public class MyComponent : MonoBehaviour
{
    private void OnEnable()
    {
        // 在 OnEnable 中订阅事件
        EventManager.AddListener(EventType.PlayerDied, OnPlayerDied);
    }

    private void OnDisable()
    {
        // ⚠️ 必须在 OnDisable 中取消订阅
        EventManager.RemoveListener(EventType.PlayerDied, OnPlayerDied);
    }

    private void OnPlayerDied()
    {
        // 事件处理逻辑
    }
}
```

### ⚠️ 重要约定

- 事件订阅和取消订阅必须配对
- 防止内存泄漏
- 使用相同的 Dispatcher 对象

---

## 调试工具

### 编辑器工具

- **ABAnalysis**: AB 包分析工具
- **ReferenceFinder**: 资源引用追踪工具
- **AI Behavior Tree Editor**: 可视化 AI 编辑器

### 运行时工具

- **Unity Profiler**: 性能分析
- **SoulLogs/**: 游戏日志目录
- **RuntimeInspector**: 运行时检视器

### 日志系统

```csharp
// ❌ 禁止使用 UnityEngine.Debug
// Debug.Log("Message");

// ✅ 使用项目封装的 Debuger 类
Debuger.LogInfo(EDebugTag.Battle, "Message");
Debuger.LogWarning(EDebugTag.Network, "Warning");
Debuger.LogError(EDebugTag.AI, "Error");
```

---

## 系统集成注意事项

### 相机 + 渲染
- 相机操作必须通过 SoulCameraManager
- 考虑 SOC 剔除系统的影响
- 确保与 Cinemachine 的集成正确

### 战斗 + 回放
- 修改战斗逻辑必须测试回放兼容性
- 确保确定性执行
- 避免随机数和时间相关的非确定性操作

### 网络 + 安全
- 所有 RPC 必须校验参数
- 服务器权威架构
- 关键数据使用 ServerAll 同步模式

### 热更新 + ILRuntime
- 避免使用不支持的特性
- 注意 ref/out 参数的兼容性
- 保持序列化版本兼容性
